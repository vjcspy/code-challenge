# =============================================================================
# Docker Compose for Local Development
# 
# Services:
# - postgres: PostgreSQL database
# - kong: Kong API Gateway
# - app: Token Price API (with hot-reload)
# 
# Usage:
#   npm run dev           # Start all services
#   npm run dev:app       # Start app only (requires external DB)
#   npm run dev:down      # Stop all services
#   npm run dev:logs      # View logs
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: token-price-postgres
    environment:
      POSTGRES_DB: token_price_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d token_price_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - token-price-network

  # ===========================================================================
  # Kong API Gateway (DB-less mode)
  # ===========================================================================
  kong:
    image: kong:3.4
    container_name: token-price-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
    ports:
      - "8000:8000"  # Proxy
      - "8001:8001"  # Admin API
    volumes:
      - ./kong:/kong:ro
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 5
    depends_on:
      app:
        condition: service_healthy
    networks:
      - token-price-network

  # ===========================================================================
  # Token Price API (with hot-reload)
  # ===========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: token-price-app
    environment:
      NODE_ENV: development
      PORT: 3000
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/token_price_db?schema=public
      PRICE_API_URL: https://interview.switcheo.com/prices.json
      PRICE_SYNC_INTERVAL_MS: 30000
      LOG_LEVEL: info
    ports:
      - "3000:3000"
    volumes:
      # Mount source code for hot-reload
      - ./src:/app/src:ro
      - ./prisma:/app/prisma:ro
      - ./data:/app/data:ro
      # Exclude node_modules (use container's node_modules)
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - token-price-network
    # Run migrations before starting the app
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        npx prisma migrate deploy &&
        echo 'Starting app with hot-reload...' &&
        npm run dev:local
      "

# ===========================================================================
# Networks
# ===========================================================================
networks:
  token-price-network:
    driver: bridge

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  postgres_data:

