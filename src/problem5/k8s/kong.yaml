# =============================================================================
# Kong Gateway Kubernetes Deployment
# DB-less mode with declarative configuration
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    services:
      - name: token-price-api
        url: http://token-price-app:3000
        routes:
          - name: api-routes
            paths:
              - /api
            strip_path: false
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS

      - name: health-service
        url: http://token-price-app:3000
        routes:
          - name: health-routes
            paths:
              - /health
            strip_path: false
            methods:
              - GET

    plugins:
      - name: correlation-id
        config:
          header_name: X-Correlation-ID
          generator: uuid
          echo_downstream: true

      - name: rate-limiting
        service: token-price-api
        config:
          minute: 100
          policy: local
          fault_tolerant: true
          hide_client_headers: false

      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Content-Type
            - Authorization
            - X-Client-ID
            - X-Client-Type
            - X-Scope
            - X-Correlation-ID
          exposed_headers:
            - X-Correlation-ID
            - X-RateLimit-Limit-Minute
            - X-RateLimit-Remaining-Minute
          credentials: false
          max_age: 3600

      - name: request-transformer
        service: token-price-api
        config:
          add:
            headers:
              - "X-Kong-Proxy:true"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong
  labels:
    app: kong
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kong
  template:
    metadata:
      labels:
        app: kong
    spec:
      containers:
        - name: kong
          image: kong:3.4
          ports:
            - name: proxy
              containerPort: 8000
            - name: admin
              containerPort: 8001
          env:
            - name: KONG_DATABASE
              value: "off"
            - name: KONG_DECLARATIVE_CONFIG
              value: /kong/kong.yml
            - name: KONG_PROXY_ACCESS_LOG
              value: /dev/stdout
            - name: KONG_ADMIN_ACCESS_LOG
              value: /dev/stdout
            - name: KONG_PROXY_ERROR_LOG
              value: /dev/stderr
            - name: KONG_ADMIN_ERROR_LOG
              value: /dev/stderr
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001"
          volumeMounts:
            - name: kong-config
              mountPath: /kong
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 15
            periodSeconds: 10
      volumes:
        - name: kong-config
          configMap:
            name: kong-config

---
apiVersion: v1
kind: Service
metadata:
  name: kong
  labels:
    app: kong
spec:
  type: ClusterIP
  ports:
    - name: proxy
      port: 8000
      targetPort: 8000
    - name: admin
      port: 8001
      targetPort: 8001
  selector:
    app: kong

